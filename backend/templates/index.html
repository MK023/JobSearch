<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ Job Search Command Center</title>
    <link rel="stylesheet" href="/static/css/style.css?v=6">
</head>
<body>
<div class="c">
    <div class="top">
        <h1>ğŸ¯ Job Search Command Center</h1>
        {% if spending %}
        <div class="spend" id="spend-bar">
            <span>ğŸ’³ Crediti: <b id="sp-budget" class="bal" contenteditable="true" title="Clicca per impostare i tuoi crediti Anthropic">${{ '%.2f' % spending.budget }}</b></span>
            <span>ğŸ’° Speso: <b id="sp-cost">${{ '%.4f' % spending.total_cost_usd }}</b></span>
            <span>ğŸ¦ Rimanente: <b id="sp-remain" class="bal">{% if spending.remaining is not none %}${{ '%.4f' % spending.remaining }}{% else %}-{% endif %}</b></span>
            <span>ğŸ“… Oggi: <b id="sp-today">${{ '%.4f' % spending.today_cost_usd }} ({{ spending.today_analyses }} analisi, {{ '{:,}'.format(spending.today_tokens_input + spending.today_tokens_output) }} tok)</b></span>
        </div>
        {% endif %}
    </div>

    {% if message %}<div class="msg msg-ok">âœ… {{ message }}</div>{% endif %}
    {% if error %}<div class="msg msg-err">âŒ {{ error }}</div>{% endif %}

    <div class="grid">
        <div class="card">
            <h2>ğŸ“„ Il tuo CV</h2>
            {% if cv %}
            <div class="cv-st cv-ok">âœ… CV caricato ({{ cv.name or 'senza nome' }}) &mdash; incolla di nuovo per aggiornare</div>
            {% else %}
            <div class="cv-st cv-no">âš ï¸ Nessun CV &mdash; incollalo qui sotto</div>
            {% endif %}
            <form method="post" action="/cv" id="cv-form">
                <input type="text" name="cv_name" placeholder="ğŸ‘¤ Il tuo nome (opzionale)" value="{{ cv.name if cv else '' }}">
                <textarea name="cv_text" id="cv-text" placeholder="ğŸ“‹ Incolla qui il tuo CV completo..."></textarea>
                <div class="btns">
                    <button type="submit" class="btn btn-p btn-s">ğŸ’¾ Salva CV</button>
                    <button type="button" class="btn btn-muted btn-s" onclick="uploadCV()">ğŸ“¤ Carica file</button>
                    {% if cv %}<a href="/cv/download" class="btn btn-muted btn-s">ğŸ“¥ Scarica CV</a>{% endif %}
                </div>
                <input type="file" id="cv-file" accept=".txt,.pdf,.doc,.docx,.rtf" hidden>
            </form>
        </div>
        <div class="card">
            <h2>ğŸ” Analizza candidatura</h2>
            <form method="post" action="/analyze" id="af">
                <input type="url" name="job_url" placeholder="ğŸ”— Link annuncio (LinkedIn, Indeed...) - opzionale">
                <textarea name="job_description" placeholder="ğŸ“ Incolla qui la descrizione del lavoro..."></textarea>
                <div class="btns">
                    <button type="submit" class="btn btn-a btn-s" id="ab">âš¡ Analizza</button>
                    <div class="toggle">
                        <input type="radio" name="model" value="haiku" id="mh" checked><label for="mh">ğŸ‡ Haiku</label>
                        <input type="radio" name="model" value="sonnet" id="ms"><label for="ms">ğŸ§  Sonnet</label>
                    </div>
                </div>
            </form>
            <div class="loading" id="ld"><div class="spin"></div><span>ğŸ¤– Analisi AI in corso...</span></div>
        </div>
    </div>

    <!-- ========== COVER LETTER (visibile solo con analisi aperta) ========== -->
    {% set cl_analyses = analyses|rejectattr('status','equalto','scartato')|list %}
    {% if current and current.status != 'scartato' and cl_analyses %}
    <div class="card card-mb" id="cl-card">
        <h2>âœ‰ï¸ Cover Letter &mdash; <span class="cl-ref">{{ current.role or 'Ruolo' }} @ {{ current.company or 'Azienda' }}</span></h2>
        <form method="post" action="/cover-letter" id="clf">
            <input type="hidden" name="analysis_id" value="{{ current.id }}" id="cl-analysis-id">
            <div class="btns">
                <select name="language" class="select select-inline">
                    <option value="italiano">ğŸ‡®ğŸ‡¹ Italiano</option>
                    <option value="english">ğŸ‡¬ğŸ‡§ English</option>
                    <option value="francais">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                    <option value="deutsch">ğŸ‡©ğŸ‡ª Deutsch</option>
                    <option value="espanol">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                </select>
                <div class="toggle">
                    <input type="radio" name="model" value="haiku" id="clmh" checked><label for="clmh">ğŸ‡ Haiku</label>
                    <input type="radio" name="model" value="sonnet" id="clms"><label for="clms">ğŸ§  Sonnet</label>
                </div>
                <button type="submit" class="btn btn-g btn-s">âœ‰ï¸ Genera Cover Letter</button>
            </div>
        </form>
        <div class="loading" id="cld"><div class="spin"></div><span>âœï¸ Generazione in corso...</span></div>
    </div>
    {% endif %}

    {% if cover_letter_result %}
    <div class="card card-mb" id="cl-result-card">
        <h2>âœ‰ï¸ Cover Letter generata</h2>
        <div>
            <div class="advice-title advice-title-green">ğŸ“ Lettera</div>
            <div id="cl-text" class="cl-text">{{ cover_letter_result.cover_letter }}</div>
            <button class="btn btn-muted btn-s" onclick="navigator.clipboard.writeText(document.getElementById('cl-text').textContent)">ğŸ“‹ Copia lettera</button>
        </div>
        {% if cover_letter_result.subject_lines %}
        <div>
            <div class="advice-title advice-title-amber">ğŸ“§ Subject line suggerite</div>
            {% for sl in cover_letter_result.subject_lines %}
            <div class="sl-row">
                <span class="sl-text" id="sl-{{ loop.index }}">{{ sl }}</span>
                <button class="btn btn-muted btn-s" onclick="navigator.clipboard.writeText(document.getElementById('sl-{{ loop.index }}').textContent)">ğŸ“‹ Copia</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <div class="meta-small">
            ğŸ’° Costo: ${{ '%.5f' % cover_letter_result.cost_usd }} | ğŸ”¤ {{ cover_letter_result.tokens.total }} token
        </div>
    </div>
    {% endif %}

    <!-- ========== FOLLOW-UP ALERTS ========== -->
    {% if followup_alerts %}
    <div class="fu-alerts">
        <h2>ğŸ”” Follow-up da fare</h2>
        {% for fa in followup_alerts %}
        <div class="fu-alert" id="fu-{{ fa.id }}">
            <div class="fu-alert-icon">â°</div>
            <div class="fu-alert-info">
                <div class="fu-alert-role">{{ fa.role }} @ {{ fa.company }}</div>
                <div class="fu-alert-days">Candidatura inviata il {{ fa.applied_at.strftime('%d/%m/%Y') if fa.applied_at else '?' }}</div>
            </div>
            <div class="fu-alert-actions">
                <button class="btn btn-g btn-s" onclick="genFollowup('{{ fa.id }}')">âœ‰ï¸ Genera email</button>
                <button class="btn btn-b btn-s" onclick="genLinkedin('{{ fa.id }}')">ğŸ’¼ LinkedIn</button>
                <button class="btn btn-muted btn-s" onclick="markFollowupDone('{{ fa.id }}')">âœ… Fatto</button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ========== BATCH ANALYSIS ========== -->
    <div class="card card-mb">
        <h2>ğŸ“¦ Analisi multipla</h2>
        <div id="batch-form">
            <input type="url" id="batch-url" placeholder="ğŸ”— Link annuncio (opzionale)">
            <textarea id="batch-jd" placeholder="ğŸ“ Incolla la descrizione del lavoro..." class="batch-textarea"></textarea>
            <div class="btns">
                <button class="btn btn-a btn-s" onclick="batchAdd()">â• Aggiungi alla coda</button>
                <div class="toggle">
                    <input type="radio" name="batch_model" value="haiku" id="bmh" checked><label for="bmh">ğŸ‡ Haiku</label>
                    <input type="radio" name="batch_model" value="sonnet" id="bms"><label for="bms">ğŸ§  Sonnet</label>
                </div>
            </div>
        </div>
        <div id="batch-queue"></div>
        <div id="batch-actions" style="display:none" class="btns">
            <button class="btn btn-g btn-s" onclick="batchRun()">ğŸš€ Analizza tutti</button>
            <button class="btn btn-r btn-s" onclick="batchClear()">ğŸ—‘ï¸ Svuota coda</button>
            <span id="batch-status-text" class="batch-status"></span>
        </div>
    </div>

    <!-- ========== RISULTATO ========== -->
    {% if result %}
    <div class="card res">

        <!-- 1. HERO: punteggio + ruolo + info rapide -->
        <div class="hero">
            <div class="score score-{{ result.recommendation|lower }}">{{ result.score }}</div>
            <div class="hero-info">
                <div class="hero-top">
                    <span class="rec rec-{{ result.recommendation }}">{% if result.recommendation == 'APPLY' %}ğŸš€{% elif result.recommendation == 'CONSIDER' %}ğŸ¤”{% else %}â›”{% endif %} {{ result.recommendation }}</span>
                    <span class="hero-role">{{ result.role }} @ {{ result.company }}</span>
                </div>
                {% if result.score_label %}<div class="hero-label">{{ result.score_label }}</div>{% endif %}
                <div class="hero-tags">
                    {% if result.location %}<span class="ht ht-loc">ğŸ“ {{ result.location }}</span>{% endif %}
                    {% if result.work_mode %}<span class="ht ht-mode">ğŸ¢ {{ result.work_mode }}</span>{% endif %}
                    {% if result.salary_info %}<span class="ht ht-sal">ğŸ’¶ {{ result.salary_info }}</span>{% endif %}
                    {% if result.potential_score %}<span class="ht ht-pot">ğŸ“ˆ Potenziale: {{ result.potential_score }}/100</span>{% endif %}
                    {% if result.gap_timeline %}<span class="ht ht-time">â±ï¸ {{ result.gap_timeline }}</span>{% endif %}
                    {% if result.confidence %}<span class="ht ht-conf">ğŸ¯ {{ result.confidence }}{% if result.confidence_reason %}: {{ result.confidence_reason }}{% endif %}</span>{% endif %}
                    {% if result.application_method %}
                    {% set am = result.application_method %}
                    {% if am.type == 'email' %}
                    <span class="ht ht-sal">ğŸ“§ <a href="mailto:{{ am.detail }}" style="color:inherit">{{ am.detail }}</a></span>
                    {% elif am.type == 'quick_apply' %}
                    <span class="ht ht-pot">âš¡ Quick Apply{{ ' - ' + am.detail if am.detail else '' }}</span>
                    {% elif am.type == 'link' %}
                    <span class="ht ht-sal">ğŸ”— <a href="{{ am.detail }}" target="_blank" style="color:inherit">Candidati qui</a></span>
                    {% else %}
                    <span class="ht ht-conf">â“ Metodo candidatura non chiaro</span>
                    {% endif %}
                    {% if am.note %}<span class="ht ht-conf">ğŸ“Œ {{ am.note }}</span>{% endif %}
                    {% endif %}
                    {% if result.company_reputation and result.company_reputation.glassdoor_estimate and result.company_reputation.glassdoor_estimate != 'non disponibile' %}
                    {% set gr = result.company_reputation.glassdoor_estimate|replace('/5','')|float(0) %}
                    {% set is_api = result.company_reputation.source|default('') == 'glassdoor_api' %}
                    <span class="ht {% if gr >= 4.0 %}ht-sal{% elif gr >= 3.0 %}ht-time{% else %}tag-r{% endif %}" title="{{ result.company_reputation.note|default('') }}">
                        â­ Glassdoor {% if not is_api %}~{% endif %}{{ result.company_reputation.glassdoor_estimate }}{% if is_api and result.company_reputation.review_count %} ({{ '{:,}'.format(result.company_reputation.review_count).replace(',', '.') }}){% endif %}
                    </span>
                    {% elif result.company_reputation %}
                    <span class="ht ht-conf" title="{{ result.company_reputation.note|default('') }}">â­ Glassdoor: n/d</span>
                    {% endif %}
                </div>
            </div>
            <div class="hero-meta">
                <span class="pill">ğŸ’²{{ '%.5f' % result.cost_usd }}</span><br>
                <span class="meta-small">{{ result.tokens.total }} tok{% if result.from_cache %} Â· âš¡ cache{% endif %}</span>
            </div>
        </div>

        {% if result.company_reputation and (result.company_reputation.known_pros or result.company_reputation.known_cons or result.company_reputation.source|default('') == 'glassdoor_api') %}
        {% set rep = result.company_reputation %}
        {% set is_api = rep.source|default('') == 'glassdoor_api' %}
        <details open>
            <summary>ğŸ¢ Reputazione aziendale
                {% set gr_str = rep.glassdoor_estimate|default('non disponibile') %}
                {% if gr_str != 'non disponibile' %}
                {% set gr = gr_str|replace('/5','')|float(0) %}
                <span class="rep-rating {% if gr >= 4.0 %}rep-rating-good{% elif gr >= 3.0 %}rep-rating-mid{% else %}rep-rating-low{% endif %}">
                    â­ {{ gr_str }}
                </span>
                {% if is_api and rep.review_count %}
                <span class="rep-reviews">{{ '{:,}'.format(rep.review_count).replace(',', '.') }} recensioni</span>
                {% endif %}
                {% else %}
                <span class="rep-rating rep-rating-na">â­ n/d</span>
                {% endif %}
            </summary>

            {% if is_api and rep.sub_ratings %}
            <div class="sub-ratings">
                {% set sr_labels = {'culture': 'Cultura', 'compensation': 'Compenso', 'work_life_balance': 'Work-Life Balance', 'career_opportunities': 'Carriera', 'senior_management': 'Management', 'diversity': 'Diversita\''} %}
                {% for key, label in sr_labels.items() %}
                {% if rep.sub_ratings[key] is defined and rep.sub_ratings[key] %}
                {% set val = rep.sub_ratings[key] %}
                <div class="sr-row">
                    <span class="sr-label">{{ label }}</span>
                    <div class="sr-bar-bg">
                        <div class="sr-bar {% if val >= 4.0 %}sr-bar-good{% elif val >= 3.0 %}sr-bar-mid{% else %}sr-bar-low{% endif %}" style="width:{{ (val / 5 * 100)|round }}%"></div>
                    </div>
                    <span class="sr-val">{{ '%.1f' % val }}</span>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            {% if is_api and (rep.ceo_name or rep.ceo_approval or rep.recommend_to_friend or rep.business_outlook) %}
            <div class="ceo-info">
                {% if rep.ceo_name %}<span class="ceo-name">ğŸ‘” CEO: {{ rep.ceo_name }}{% if rep.ceo_approval %} ({{ rep.ceo_approval }}% approvazione){% endif %}</span>{% endif %}
                {% if rep.recommend_to_friend %}<span class="ceo-detail">ğŸ‘ {{ rep.recommend_to_friend }}% consiglia</span>{% endif %}
                {% if rep.business_outlook %}<span class="ceo-detail">ğŸ“ˆ Outlook: {{ rep.business_outlook }}%</span>{% endif %}
            </div>
            {% endif %}

            <div class="rep-grid">
                {% if rep.known_pros %}
                <div class="rep-col rep-pros">
                    <div class="rep-label rep-label-pro">ğŸ‘ Punti di forza</div>
                    {% for p in rep.known_pros %}
                    <div class="rep-item">âœ… {{ p }}</div>
                    {% endfor %}
                </div>
                {% endif %}
                {% if rep.known_cons %}
                <div class="rep-col rep-cons">
                    <div class="rep-label rep-label-con">ğŸ‘ Criticita'</div>
                    {% for c in rep.known_cons %}
                    <div class="rep-item">âš ï¸ {{ c }}</div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="rep-footer">
                {% if rep.note %}<span class="rep-note">{{ rep.note }}</span>{% endif %}
                {% if is_api and rep.glassdoor_url %}
                <a href="{{ rep.glassdoor_url }}" target="_blank" class="gd-link">ğŸ”— Vedi su Glassdoor</a>
                {% endif %}
                <span class="rep-badge {% if is_api %}rep-badge-verified{% else %}rep-badge-estimate{% endif %}">
                    {% if is_api %}âœ… Dati Glassdoor verificati{% else %}ğŸ¤– Stima AI{% endif %}
                </span>
            </div>
        </details>
        {% endif %}

        <!-- 2. VERDETTO AI -->
        {% if result.summary %}
        <div class="verdict">ğŸ§  {{ result.summary }}</div>
        {% endif %}

        <!-- 4. PUNTI CHIAVE ANNUNCIO -->
        {% if result.job_summary %}
        <div class="jd-box">
            <div class="jd-title">ğŸ“‹ Punti chiave dell'annuncio</div>
            <div class="jd-text">{{ result.job_summary }}</div>
        </div>
        {% endif %}

        <!-- 5. FORZA + LACUNE side by side -->
        <div class="grid2">
            <div class="str-section">
                <div class="str-header">
                    <div class="sec-title">ğŸ’ª I tuoi punti di forza</div>
                    <span class="str-count">{{ result.strengths|length }}</span>
                </div>
                {% for s in result.strengths %}
                <div class="str-item">
                    <span class="str-icon">âœ…</span>
                    <span class="str-text">{{ s }}</span>
                </div>
                {% endfor %}
            </div>
            <div class="gap-section">
                <div class="str-header">
                    <div class="sec-title">ğŸŒ± Aree di crescita</div>
                    <span class="str-count str-count-muted">{{ result.gaps|length }}</span>
                </div>
                {% for g in result.gaps %}
                    {% if g is mapping %}
                    <div class="gap-item sev-{{ g.severity }}-border">
                        <div class="gap-top">
                            <span class="sev sev-{{ g.severity }}">{% if g.severity == 'bloccante' %}ğŸš«{% elif g.severity == 'importante' %}âš ï¸{% else %}ğŸ’¡{% endif %} {{ g.severity }}</span>
                            <span class="gap-name">{{ g.gap }}</span>
                            {% if g.closable %}<span class="gap-closable">âœ¨ colmabile</span>{% else %}<span class="gap-not">ğŸ”’ difficile</span>{% endif %}
                        </div>
                        {% if g.how %}
                        <div class="gap-how">
                            <span class="gap-how-icon">ğŸ› ï¸</span>
                            <span>{{ g.how }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <span class="tag tag-r">{{ g }}</span>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- 5b. CONSIGLIO PERSONALIZZATO -->
        {% if result.advice %}
        <div class="advice-box">
            <div class="advice-title">ğŸ’¡ Il mio consiglio per te</div>
            <div class="advice-text">{{ result.advice }}</div>
        </div>
        {% endif %}

        <!-- 6. COLLOQUIO (collassabile) -->
        {% if result.interview_scripts %}
        <details>
            <summary>ğŸ¤ Preparazione colloquio ({{ result.interview_scripts|length }} domande)</summary>
            {% for s in result.interview_scripts %}
            <div class="script">
                <div class="script-q">â“ {{ s.question }}</div>
                <div class="script-a">ğŸ’¬ {{ s.suggested_answer }}</div>
            </div>
            {% endfor %}
        </details>
        {% endif %}

        <!-- 7. AZIONI -->
        {% if current %}
        <div class="actions" id="actions-{{ current.id }}">
            {% if current.job_url %}
            <a href="{{ current.job_url }}" target="_blank" class="btn btn-b btn-s">ğŸ”— Apri annuncio</a>
            {% endif %}
            <div class="pill-group" data-analysis-id="{{ current.id }}">
                <button class="pill-btn pill-da_valutare {{ 'active' if (current.status or 'da_valutare') == 'da_valutare' }}" data-status="da_valutare" onclick="setStatus(this)">ğŸ” Da valutare</button>
                <button class="pill-btn pill-candidato {{ 'active' if current.status == 'candidato' }}" data-status="candidato" onclick="setStatus(this)">ğŸ“¨ Candidato</button>
                <button class="pill-btn pill-colloquio {{ 'active' if current.status == 'colloquio' }}" data-status="colloquio" onclick="setStatus(this)">ğŸ—£ï¸ Colloquio</button>
                <button class="pill-btn pill-scartato {{ 'active' if current.status == 'scartato' }}" data-status="scartato" onclick="setStatus(this)">âŒ Scartato</button>
            </div>
            <button class="btn btn-r btn-s" onclick="deleteAnalysis('{{ current.id }}')">ğŸ—‘ï¸ Elimina</button>
        </div>

        {% endif %}
    </div>
    {% endif %}

    <!-- ========== STORICO ========== -->
    {% if analyses %}
    <div class="hist card">
        <h2>ğŸ“š Storico analisi</h2>
        <div class="tabs" id="hist-tabs">
            <div class="tab active" data-tab="valutazione" onclick="switchTab(this)">In valutazione <span class="tab-badge" id="badge-valutazione">0</span></div>
            <div class="tab" data-tab="applicato" onclick="switchTab(this)">Candidature <span class="tab-badge" id="badge-applicato">0</span></div>
            <div class="tab" data-tab="skippato" onclick="switchTab(this)">Scartati <span class="tab-badge" id="badge-skippato">0</span></div>
        </div>
        <div class="hist-card" id="hist-list">
            {% for a in analyses %}
            <div class="hi" data-hist-id="{{ a.id }}" data-hist-status="{{ a.status or 'da_valutare' }}">
                <a href="/analysis/{{ a.id }}" class="hi-link">
                    <div class="hi-score score-{{ a.recommendation|lower }}">{{ a.score }}</div>
                    <div class="hi-info">
                        <div class="hi-role">{{ a.role or 'Ruolo sconosciuto' }}</div>
                        <div class="hi-co">{{ a.company or 'Azienda sconosciuta' }}{% if a.work_mode %} Â· {{ a.work_mode }}{% endif %}{% if a.salary_info %} Â· {{ a.salary_info }}{% endif %}</div>
                    </div>
                    <span class="st st-{{ a.status or 'da_valutare' }}">{% if a.status == 'candidato' %}ğŸ“¨{% elif a.status == 'colloquio' %}ğŸ—£ï¸{% elif a.status == 'scartato' %}âŒ{% else %}ğŸ”{% endif %} {{ (a.status or 'da valutare')|replace('_',' ') }}</span>
                    <span class="rec rec-{{ a.recommendation }} rec-sm">{{ a.recommendation }}</span>
                    <span class="hi-date">${{ '%.4f' % (a.cost_usd or 0) }}<br>{{ a.created_at.strftime('%d/%m %H:%M') if a.created_at else '' }}</span>
                </a>
                <button class="btn btn-r btn-s" onclick="deleteAnalysis('{{ a.id }}')" title="Elimina">ğŸ—‘ï¸</button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ========== DASHBOARD (collapsible, real-time) ========== -->
    <details class="dash card" id="dash-details" {% if dashboard and dashboard.total > 0 %}{% else %}style="display:none"{% endif %}>
        <summary class="dash-summary">ğŸ“Š La tua ricerca <span class="dash-summary-stats" id="dash-summary-stats">{% if dashboard %}{{ dashboard.total }} analisi Â· {{ dashboard.applied }} candidature Â· score medio {{ dashboard.avg_score }}{% endif %}</span></summary>
        <div class="dash-grid">
            <div class="dash-stat">
                <div class="dash-num" id="dash-total">{{ dashboard.total if dashboard else 0 }}</div>
                <div class="dash-label">Analizzate</div>
            </div>
            <div class="dash-stat dash-stat-blue">
                <div class="dash-num" id="dash-applied">{{ dashboard.applied if dashboard else 0 }}</div>
                <div class="dash-label">Candidature</div>
            </div>
            <div class="dash-stat dash-stat-green">
                <div class="dash-num" id="dash-interviews">{{ dashboard.interviews if dashboard else 0 }}</div>
                <div class="dash-label">Colloqui</div>
            </div>
            <div class="dash-stat">
                <div class="dash-num" id="dash-avg">{{ dashboard.avg_score if dashboard else 0 }}</div>
                <div class="dash-label">Score medio</div>
            </div>
            <div class="dash-stat dash-stat-amber" id="dash-followup-box" {% if not dashboard or dashboard.followup_count == 0 %}style="display:none"{% endif %}>
                <div class="dash-num" id="dash-followup">{{ dashboard.followup_count if dashboard else 0 }}</div>
                <div class="dash-label">Follow-up</div>
            </div>
            <div class="dash-stat dash-stat-red">
                <div class="dash-num" id="dash-skipped">{{ dashboard.skipped if dashboard else 0 }}</div>
                <div class="dash-label">Scartate</div>
            </div>
        </div>
        <div class="dash-motivation" id="dash-motivation" {% if not dashboard or not dashboard.top_match %}style="display:none"{% endif %}>
            {% if dashboard and dashboard.top_match %}
            ğŸ† Miglior match: <b>{{ dashboard.top_match.role }}</b> @ {{ dashboard.top_match.company }} ({{ dashboard.top_match.score }}/100)
            {% if dashboard.applied > 0 %} Â· Hai gia' inviato {{ dashboard.applied }} candidatur{{ 'a' if dashboard.applied == 1 else 'e' }} - continua cosi'!{% endif %}
            {% endif %}
        </div>

        {% if active_apps %}
        <div class="dash-active">
            <div class="dash-active-title">ğŸ“¬ Candidature attive</div>
            {% for a in active_apps %}
            <div class="dash-active-row">
                <a href="/analysis/{{ a.id }}" class="dash-active-info">
                    <span class="dash-active-role">{{ a.role }}</span>
                    <span class="dash-active-co">{{ a.company }}</span>
                    <span class="st st-{{ a.status }}">{{ a.status|replace('_',' ') }}</span>
                    {% if a.applied_at %}<span class="dash-active-date">{{ a.applied_at.strftime('%d/%m') }}</span>{% endif %}
                </a>
                <div class="dash-active-tools">
                    <button class="tool-btn" onclick="genFollowup('{{ a.id }}')" title="Genera email follow-up">âœ‰ï¸</button>
                    <button class="tool-btn" onclick="genLinkedin('{{ a.id }}')" title="Genera messaggio LinkedIn">ğŸ’¼</button>
                    <button class="tool-btn" onclick="toggleContacts('{{ a.id }}')" title="Gestisci contatti recruiter">ğŸ‘¤</button>
                </div>
                <div id="contacts-{{ a.id }}" style="display:none" class="dash-contacts-panel">
                    <div id="contacts-list-{{ a.id }}"></div>
                    <div class="contact-form">
                        <input type="text" id="ct-name-{{ a.id }}" placeholder="Nome">
                        <input type="email" id="ct-email-{{ a.id }}" placeholder="Email">
                        <input type="tel" id="ct-phone-{{ a.id }}" placeholder="Telefono">
                        <input type="text" id="ct-company-{{ a.id }}" placeholder="Azienda" value="{{ a.company or '' }}">
                        <input type="url" id="ct-linkedin-{{ a.id }}" placeholder="LinkedIn URL">
                        <input type="text" id="ct-notes-{{ a.id }}" placeholder="Note">
                    </div>
                    <div class="btns" style="margin-top:6px">
                        <button class="btn btn-p btn-s" onclick="saveContact('{{ a.id }}')">ğŸ’¾ Salva</button>
                    </div>
                </div>
                <div id="gen-area-{{ a.id }}"></div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </details>

    <div class="foot">ğŸ¯ Job Search Command Center</div>
</div>

<script src="/static/js/app.js?v=6"></script>
</body>
</html>
