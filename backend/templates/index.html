<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ Job Search Command Center</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}
        .c{max-width:1100px;margin:0 auto;padding:20px 16px}
        h1{font-size:1.4rem;font-weight:700;color:#f8fafc}
        h2{font-size:1.05rem;font-weight:600;margin-bottom:10px;color:#cbd5e1}
        a{color:#818cf8;text-decoration:none}a:hover{text-decoration:underline}

        /* Header + spending */
        .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px}
        .spend{display:flex;gap:16px;font-size:.78rem;flex-wrap:wrap;align-items:center}
        .spend span{color:#64748b}.spend b{color:#e2e8f0}.spend .bal{color:#34d399}
        .bar-bg{width:100px;height:5px;background:#334155;border-radius:3px;overflow:hidden}
        .bar-fg{height:100%;background:#6366f1;border-radius:3px}

        /* Layout */
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;align-items:start}
        .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
        @media(max-width:768px){.grid,.grid2{grid-template-columns:1fr}}

        /* Card + form */
        .card{background:#1e293b;border:1px solid #334155;border-radius:10px;padding:16px}
        textarea{width:100%;min-height:140px;background:#0f172a;border:1px solid #475569;border-radius:6px;padding:10px;color:#e2e8f0;font-size:.85rem;font-family:inherit;resize:vertical}
        textarea:focus{outline:none;border-color:#6366f1}
        input[type="text"],input[type="url"]{width:100%;background:#0f172a;border:1px solid #475569;border-radius:6px;padding:8px 10px;color:#e2e8f0;font-size:.85rem;margin-bottom:8px}
        input:focus{outline:none;border-color:#6366f1}

        /* Buttons */
        .btn{display:inline-block;padding:8px 16px;border:none;border-radius:6px;font-size:.82rem;font-weight:600;cursor:pointer;text-decoration:none;transition:opacity .15s}
        .btn:hover{opacity:.85}
        .btn-p{background:#6366f1;color:#fff}.btn-a{background:#f59e0b;color:#1e293b}
        .btn-g{background:#059669;color:#fff}.btn-b{background:#2563eb;color:#fff}
        .btn-r{background:#dc2626;color:#fff}.btn-muted{background:#334155;color:#94a3b8}
        .btn-s{padding:5px 12px;font-size:.78rem}
        .btns{display:flex;gap:6px;margin-top:10px;align-items:center;flex-wrap:wrap}

        .toggle{display:flex;gap:3px;background:#0f172a;border-radius:6px;padding:2px;border:1px solid #334155}
        .toggle label{padding:5px 12px;border-radius:5px;font-size:.78rem;cursor:pointer;font-weight:500}
        .toggle input{display:none}
        .toggle input:checked+label{background:#6366f1;color:#fff}

        .msg{padding:8px 12px;border-radius:6px;margin-bottom:12px;font-size:.85rem}
        .msg-ok{background:#065f46;color:#a7f3d0}.msg-err{background:#7f1d1d;color:#fca5a5}

        .cv-st{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;font-size:.78rem;margin-bottom:10px}
        .cv-ok{background:#064e3b;color:#6ee7b7}.cv-no{background:#78350f;color:#fbbf24}

        /* === RISULTATO === */
        .res{margin-top:20px}

        /* 1. Hero: score grande + info essenziali */
        .hero{display:flex;gap:16px;align-items:flex-start;padding-bottom:16px;border-bottom:1px solid #334155;margin-bottom:16px}
        .score{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:800;flex-shrink:0}
        .score-apply{background:#065f46;color:#34d399;border:3px solid #34d399}
        .score-consider{background:#78350f;color:#fbbf24;border:3px solid #fbbf24}
        .score-skip{background:#7f1d1d;color:#f87171;border:3px solid #f87171}
        .hero-info{flex:1;min-width:0}
        .hero-top{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px}
        .rec{padding:4px 12px;border-radius:14px;font-weight:700;font-size:.82rem;letter-spacing:.03em}
        .rec-APPLY{background:#34d399;color:#064e3b}.rec-CONSIDER{background:#fbbf24;color:#78350f}.rec-SKIP{background:#f87171;color:#7f1d1d}
        .hero-role{font-size:1.1rem;font-weight:700;color:#f8fafc}
        .hero-label{font-size:.82rem;color:#94a3b8;margin-top:2px}
        .hero-tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
        .ht{padding:3px 9px;border-radius:5px;font-size:.75rem;font-weight:500}
        .ht-loc{background:#1e1b4b;color:#c7d2fe}.ht-mode{background:#1e1b4b;color:#c7d2fe}
        .ht-sal{background:#064e3b;color:#6ee7b7}.ht-pot{background:#064e3b;color:#34d399}
        .ht-time{background:#78350f;color:#fbbf24}.ht-conf{background:#334155;color:#94a3b8}
        .hero-meta{font-size:.72rem;color:#475569;flex-shrink:0;text-align:right}
        .pill{padding:2px 7px;border-radius:8px;font-size:.7rem;background:#1e1b4b;color:#a5b4fc;display:inline-block}

        /* 2. Consiglio: il pezzo piu' importante */
        .advice-box{padding:14px 16px;background:#0f172a;border-radius:8px;border-left:4px solid #818cf8;margin-bottom:16px}
        .advice-title{font-size:.82rem;font-weight:700;color:#818cf8;margin-bottom:6px;text-transform:uppercase;letter-spacing:.05em}
        .advice-text{color:#c7d2fe;font-size:.87rem;line-height:1.7;white-space:pre-line}

        /* 3. Sommario annuncio */
        .jd-box{padding:12px 14px;background:#0f172a;border-radius:8px;border-left:4px solid #f59e0b;margin-bottom:16px}
        .jd-title{font-size:.82rem;font-weight:700;color:#f59e0b;margin-bottom:6px;text-transform:uppercase;letter-spacing:.05em}
        .jd-text{color:#94a3b8;font-size:.82rem;line-height:1.5;white-space:pre-line}

        /* 4. Verdetto: summary AI */
        .verdict{color:#cbd5e1;font-size:.87rem;line-height:1.6;padding:12px 14px;background:#0f172a;border-radius:8px;border-left:4px solid #6366f1;margin-bottom:16px}

        /* 5. Punti forza */
        .sec-title{font-size:.82rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px}
        .str-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
        .str-header .sec-title{margin-bottom:0}
        .str-count{background:#059669;color:#fff;font-size:.72rem;font-weight:700;padding:2px 8px;border-radius:10px}
        .str-item{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;background:linear-gradient(135deg,#064e3b 0%,#0f2922 100%);border-radius:8px;margin-bottom:6px;border:1px solid #065f46}
        .str-icon{color:#34d399;font-size:1rem;flex-shrink:0;line-height:1.3}
        .str-text{color:#a7f3d0;font-size:.85rem;font-weight:500;line-height:1.4}
        .str-section{padding:14px 16px;background:#0f172a;border-radius:10px;border:1px solid #065f46}

        /* 5b. Lacune / Aree di crescita */
        .gap-section{padding:14px 16px;background:#0f172a;border-radius:10px;border:1px solid #334155}
        .tag{display:inline-block;padding:3px 9px;border-radius:5px;font-size:.78rem;margin:2px 2px 2px 0}
        .tag-r{background:#450a0a;color:#fca5a5}

        .gap-item{padding:10px 12px;background:#1e293b;border-radius:8px;margin-bottom:8px;border-left:3px solid #475569}
        .gap-item.sev-bloccante-border{border-left-color:#f87171}
        .gap-item.sev-importante-border{border-left-color:#fbbf24}
        .gap-item.sev-minore-border{border-left-color:#60a5fa}
        .gap-top{display:flex;align-items:center;gap:8px;margin-bottom:4px}
        .gap-name{font-weight:600;font-size:.85rem;color:#e2e8f0}
        .sev{font-size:.68rem;font-weight:700;padding:2px 6px;border-radius:4px;text-transform:uppercase;flex-shrink:0}
        .sev-bloccante{background:#7f1d1d;color:#fca5a5}.sev-importante{background:#78350f;color:#fbbf24}.sev-minore{background:#1e3a5f;color:#60a5fa}
        .gap-closable{font-size:.78rem;color:#34d399;font-weight:600}
        .gap-not{font-size:.78rem;color:#94a3b8}
        .gap-how{font-size:.8rem;color:#94a3b8;line-height:1.4;padding:6px 0 0 0;display:flex;align-items:flex-start;gap:6px}
        .gap-how-icon{color:#818cf8;flex-shrink:0;font-size:.82rem}

        /* 6. Colloquio: collassabile */
        details{margin-bottom:16px}
        summary{cursor:pointer;font-size:.85rem;font-weight:700;color:#94a3b8;padding:10px 0;list-style:none;display:flex;align-items:center;gap:6px}
        summary::before{content:'';display:inline-block;width:0;height:0;border-left:5px solid #64748b;border-top:4px solid transparent;border-bottom:4px solid transparent;transition:transform .2s}
        details[open] summary::before{transform:rotate(90deg)}
        .script{background:#0f172a;border:1px solid #334155;border-radius:6px;padding:12px;margin-bottom:8px}
        .script-q{font-weight:600;color:#a5b4fc;margin-bottom:4px;font-size:.85rem}
        .script-a{color:#cbd5e1;font-size:.82rem;line-height:1.5}

        /* 7. Azioni */
        .actions{display:flex;gap:8px;padding:14px;background:#0f172a;border-radius:8px;border:1px solid #334155;align-items:center;flex-wrap:wrap}

        /* Storico */
        .hist{margin-top:28px}
        .hi{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #1e293b;cursor:pointer;transition:background .1s}
        .hi:hover{background:#253449}.hi:last-child{border-bottom:none}
        .hi-score{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.82rem;flex-shrink:0}
        .hi-info{flex:1;min-width:0}
        .hi-role{font-weight:600;font-size:.87rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .hi-co{color:#64748b;font-size:.78rem}
        .st{padding:2px 8px;border-radius:8px;font-size:.68rem;font-weight:600;text-transform:uppercase}
        .st-da_valutare{background:#334155;color:#94a3b8}.st-candidato{background:#1e3a5f;color:#60a5fa}
        .st-colloquio{background:#365314;color:#a3e635}.st-scartato{background:#450a0a;color:#fca5a5}
        .hi-date{color:#475569;font-size:.72rem;flex-shrink:0;text-align:right}

        .loading{display:none;align-items:center;gap:8px;color:#94a3b8;font-size:.85rem;margin-top:10px}
        .loading.on{display:flex}
        .spin{width:16px;height:16px;border:2px solid #475569;border-top-color:#6366f1;border-radius:50%;animation:s .6s linear infinite}
        @keyframes s{to{transform:rotate(360deg)}}

        .pill-group{display:flex;gap:4px;flex-wrap:wrap}
        .pill-btn{padding:6px 14px;border-radius:20px;border:2px solid #475569;background:transparent;color:#94a3b8;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .15s}
        .pill-btn:hover{border-color:#6366f1;color:#c7d2fe}
        .pill-da_valutare.active{background:#334155;border-color:#64748b;color:#e2e8f0}
        .pill-candidato.active{background:#1e3a5f;border-color:#3b82f6;color:#93c5fd}
        .pill-colloquio.active{background:#365314;border-color:#84cc16;color:#d9f99d}
        .pill-scartato.active{background:#450a0a;border-color:#f87171;color:#fca5a5}

        .tabs{display:flex;gap:2px;margin-bottom:12px;background:#0f172a;border-radius:8px;padding:3px;border:1px solid #334155}
        .tab{flex:1;padding:8px 12px;border-radius:6px;text-align:center;cursor:pointer;font-size:.8rem;font-weight:600;color:#64748b;transition:all .15s}
        .tab:hover{color:#94a3b8}
        .tab.active{background:#1e293b;color:#e2e8f0}
        .tab-badge{display:inline-block;min-width:18px;padding:1px 6px;border-radius:10px;font-size:.68rem;margin-left:4px;background:#334155;color:#94a3b8}
        .tab.active .tab-badge{background:#6366f1;color:#fff}

        /* Footer */
        .foot{text-align:center;padding:24px 0 8px;color:#334155;font-size:.72rem}
    </style>
</head>
<body>
<div class="c">
    <div class="top">
        <h1>ğŸ¯ Job Search Command Center</h1>
        {% if spending %}
        <div class="spend">
            <span>ğŸ’° Speso: <b>${{ '%.4f' % spending.total_cost_usd }}</b></span>
            <span>ğŸ’³ Saldo: <b class="bal">${{ '%.4f' % spending.balance_usd }}</b></span>
            <div class="bar-bg"><div class="bar-fg" style="width:{{ [(spending.total_cost_usd / 5.0 * 100)|round(1), 100]|min }}%"></div></div>
            <span>ğŸ“Š Analisi: <b>{{ spending.total_analyses }}</b></span>
            <span>ğŸ”¤ Token: <b>{{ '{:,}'.format(spending.total_tokens_input + spending.total_tokens_output) }}</b></span>
        </div>
        {% endif %}
    </div>

    {% if message %}<div class="msg msg-ok">âœ… {{ message }}</div>{% endif %}
    {% if error %}<div class="msg msg-err">âŒ {{ error }}</div>{% endif %}

    <div class="grid">
        <div class="card">
            <h2>ğŸ“„ Il tuo CV</h2>
            {% if cv %}
            <div class="cv-st cv-ok">âœ… CV caricato ({{ cv.name or 'senza nome' }}) &mdash; incolla di nuovo per aggiornare</div>
            {% else %}
            <div class="cv-st cv-no">âš ï¸ Nessun CV &mdash; incollalo qui sotto</div>
            {% endif %}
            <form method="post" action="/cv">
                <input type="text" name="cv_name" placeholder="ğŸ‘¤ Il tuo nome (opzionale)" value="{{ cv.name if cv else '' }}">
                <textarea name="cv_text" placeholder="ğŸ“‹ Incolla qui il tuo CV completo..."></textarea>
                <div class="btns">
                    <button type="submit" class="btn btn-p">ğŸ’¾ Salva CV</button>
                    {% if cv %}<button type="button" class="btn btn-muted btn-s" disabled title="Prossimamente">ğŸ“¥ Scarica CV</button>{% endif %}
                </div>
            </form>
        </div>
        <div class="card">
            <h2>ğŸ” Analizza candidatura</h2>
            <form method="post" action="/analyze" id="af">
                <input type="url" name="job_url" placeholder="ğŸ”— Link annuncio (LinkedIn, Indeed...) - opzionale">
                <textarea name="job_description" placeholder="ğŸ“ Incolla qui la descrizione del lavoro..."></textarea>
                <div class="btns">
                    <button type="submit" class="btn btn-a" id="ab">âš¡ Analizza</button>
                    <div class="toggle">
                        <input type="radio" name="model" value="haiku" id="mh" checked><label for="mh">ğŸ‡ Haiku</label>
                        <input type="radio" name="model" value="sonnet" id="ms"><label for="ms">ğŸ§  Sonnet</label>
                    </div>
                </div>
            </form>
            <div class="loading" id="ld"><div class="spin"></div><span>ğŸ¤– Analisi AI in corso...</span></div>
        </div>
    </div>

    <!-- ========== COVER LETTER ========== -->
    {% if analyses %}
    <div class="card" style="margin-bottom:20px">
        <h2>âœ‰ï¸ Cover Letter</h2>
        <form method="post" action="/cover-letter" id="clf">
            <select name="analysis_id" style="width:100%;background:#0f172a;border:1px solid #475569;border-radius:6px;padding:8px 10px;color:#e2e8f0;font-size:.85rem;margin-bottom:8px">
                {% for a in analyses %}
                <option value="{{ a.id }}">{{ a.role or 'Ruolo' }} @ {{ a.company or 'Azienda' }} ({{ a.score }}/100)</option>
                {% endfor %}
            </select>
            <div class="btns">
                <select name="language" style="background:#0f172a;border:1px solid #475569;border-radius:6px;padding:6px 10px;color:#e2e8f0;font-size:.82rem">
                    <option value="italiano">ğŸ‡®ğŸ‡¹ Italiano</option>
                    <option value="english">ğŸ‡¬ğŸ‡§ English</option>
                    <option value="francais">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                    <option value="deutsch">ğŸ‡©ğŸ‡ª Deutsch</option>
                    <option value="espanol">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                </select>
                <div class="toggle">
                    <input type="radio" name="model" value="haiku" id="clmh" checked><label for="clmh">ğŸ‡ Haiku</label>
                    <input type="radio" name="model" value="sonnet" id="clms"><label for="clms">ğŸ§  Sonnet</label>
                </div>
                <button type="submit" class="btn btn-g">âœ‰ï¸ Genera Cover Letter</button>
            </div>
        </form>
        <div class="loading" id="cld"><div class="spin"></div><span>âœï¸ Generazione in corso...</span></div>
    </div>
    {% endif %}

    {% if cover_letter_result %}
    <div class="card" style="margin-bottom:20px">
        <h2>âœ‰ï¸ Cover Letter generata</h2>
        <div style="margin-bottom:12px">
            <div class="advice-title" style="color:#059669">ğŸ“ Lettera</div>
            <div id="cl-text" style="background:#0f172a;padding:14px;border-radius:8px;border:1px solid #334155;color:#cbd5e1;font-size:.85rem;line-height:1.7;white-space:pre-line;margin-bottom:8px">{{ cover_letter_result.cover_letter }}</div>
            <button class="btn btn-muted btn-s" onclick="navigator.clipboard.writeText(document.getElementById('cl-text').textContent)">ğŸ“‹ Copia lettera</button>
        </div>
        {% if cover_letter_result.subject_lines %}
        <div>
            <div class="advice-title" style="color:#f59e0b">ğŸ“§ Subject line suggerite</div>
            {% for sl in cover_letter_result.subject_lines %}
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                <span style="background:#0f172a;padding:6px 12px;border-radius:6px;border:1px solid #334155;color:#e2e8f0;font-size:.82rem;flex:1" id="sl-{{ loop.index }}">{{ sl }}</span>
                <button class="btn btn-muted btn-s" onclick="navigator.clipboard.writeText(document.getElementById('sl-{{ loop.index }}').textContent)">ğŸ“‹ Copia</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <div style="margin-top:8px;font-size:.72rem;color:#475569">
            ğŸ’° Costo: ${{ '%.5f' % cover_letter_result.cost_usd }} | ğŸ”¤ {{ cover_letter_result.tokens.total }} token
        </div>
    </div>
    {% endif %}

    <!-- ========== BATCH ANALYSIS ========== -->
    <div class="card" style="margin-bottom:20px">
        <h2>ğŸ“¦ Analisi multipla</h2>
        <div id="batch-form">
            <input type="url" id="batch-url" placeholder="ğŸ”— Link annuncio (opzionale)" style="width:100%;background:#0f172a;border:1px solid #475569;border-radius:6px;padding:8px 10px;color:#e2e8f0;font-size:.85rem;margin-bottom:8px">
            <textarea id="batch-jd" placeholder="ğŸ“ Incolla la descrizione del lavoro..." style="width:100%;min-height:80px;background:#0f172a;border:1px solid #475569;border-radius:6px;padding:10px;color:#e2e8f0;font-size:.85rem;resize:vertical;margin-bottom:8px"></textarea>
            <div class="btns">
                <button class="btn btn-a btn-s" onclick="batchAdd()">â• Aggiungi alla coda</button>
                <div class="toggle">
                    <input type="radio" name="batch_model" value="haiku" id="bmh" checked><label for="bmh">ğŸ‡ Haiku</label>
                    <input type="radio" name="batch_model" value="sonnet" id="bms"><label for="bms">ğŸ§  Sonnet</label>
                </div>
            </div>
        </div>
        <div id="batch-queue" style="margin-top:12px"></div>
        <div id="batch-actions" style="display:none;margin-top:10px" class="btns">
            <button class="btn btn-g" onclick="batchRun()">ğŸš€ Analizza tutti</button>
            <button class="btn btn-r btn-s" onclick="batchClear()">ğŸ—‘ï¸ Svuota coda</button>
            <span id="batch-status-text" style="font-size:.82rem;color:#94a3b8"></span>
        </div>
    </div>

    <!-- ========== RISULTATO ========== -->
    {% if result %}
    <div class="card res">

        <!-- 1. HERO: punteggio + ruolo + info rapide -->
        <div class="hero">
            <div class="score score-{{ result.recommendation|lower }}">{{ result.score }}</div>
            <div class="hero-info">
                <div class="hero-top">
                    <span class="rec rec-{{ result.recommendation }}">{% if result.recommendation == 'APPLY' %}ğŸš€{% elif result.recommendation == 'CONSIDER' %}ğŸ¤”{% else %}â›”{% endif %} {{ result.recommendation }}</span>
                    <span class="hero-role">{{ result.role }} @ {{ result.company }}</span>
                </div>
                {% if result.score_label %}<div class="hero-label">{{ result.score_label }}</div>{% endif %}
                <div class="hero-tags">
                    {% if result.location %}<span class="ht ht-loc">ğŸ“ {{ result.location }}</span>{% endif %}
                    {% if result.work_mode %}<span class="ht ht-mode">ğŸ¢ {{ result.work_mode }}</span>{% endif %}
                    {% if result.salary_info %}<span class="ht ht-sal">ğŸ’¶ {{ result.salary_info }}</span>{% endif %}
                    {% if result.potential_score %}<span class="ht ht-pot">ğŸ“ˆ Potenziale: {{ result.potential_score }}/100</span>{% endif %}
                    {% if result.gap_timeline %}<span class="ht ht-time">â±ï¸ {{ result.gap_timeline }}</span>{% endif %}
                    {% if result.confidence %}<span class="ht ht-conf">ğŸ¯ {{ result.confidence }}{% if result.confidence_reason %}: {{ result.confidence_reason }}{% endif %}</span>{% endif %}
                    {% if result.company_reputation and result.company_reputation.glassdoor_estimate and result.company_reputation.glassdoor_estimate != 'non disponibile' %}
                    {% set gr = result.company_reputation.glassdoor_estimate|replace('/5','')|float %}
                    <span class="ht {% if gr >= 4.0 %}ht-sal{% elif gr >= 3.0 %}ht-time{% else %}tag-r{% endif %}" title="{{ result.company_reputation.known_pros|join(', ') }} | {{ result.company_reputation.known_cons|join(', ') }}{% if result.company_reputation.note %} - {{ result.company_reputation.note }}{% endif %}">
                        â­ Glassdoor ~{{ result.company_reputation.glassdoor_estimate }}
                    </span>
                    {% elif result.company_reputation %}
                    <span class="ht ht-conf" title="{{ result.company_reputation.note|default('') }}">â­ Glassdoor: n/d</span>
                    {% endif %}
                </div>
            </div>
            <div class="hero-meta">
                <span class="pill">ğŸ’²{{ '%.5f' % result.cost_usd }}</span><br>
                <span style="font-size:.68rem">{{ result.tokens.total }} tok{% if result.from_cache %} Â· âš¡ cache{% endif %}</span>
            </div>
        </div>

        {% if result.company_reputation and (result.company_reputation.known_pros or result.company_reputation.known_cons) %}
        <details style="margin-bottom:16px">
            <summary>ğŸ¢ Reputazione aziendale {% if result.company_reputation.glassdoor_estimate and result.company_reputation.glassdoor_estimate != 'non disponibile' %}(~{{ result.company_reputation.glassdoor_estimate }}){% endif %}</summary>
            <div style="padding:12px;background:#0f172a;border-radius:8px;border:1px solid #334155">
                {% if result.company_reputation.known_pros %}
                <div style="margin-bottom:8px"><span style="color:#34d399;font-weight:600">Pro:</span>
                {% for p in result.company_reputation.known_pros %}<span class="ht ht-sal" style="margin:2px">{{ p }}</span>{% endfor %}
                </div>{% endif %}
                {% if result.company_reputation.known_cons %}
                <div><span style="color:#f87171;font-weight:600">Contro:</span>
                {% for c in result.company_reputation.known_cons %}<span class="ht" style="background:#450a0a;color:#fca5a5;margin:2px">{{ c }}</span>{% endfor %}
                </div>{% endif %}
                {% if result.company_reputation.note %}
                <div style="margin-top:8px;font-size:.72rem;color:#475569">âš ï¸ {{ result.company_reputation.note }}</div>
                {% endif %}
            </div>
        </details>
        {% endif %}

        <!-- 2. VERDETTO AI -->
        {% if result.summary %}
        <div class="verdict">ğŸ§  {{ result.summary }}</div>
        {% endif %}

        <!-- 4. PUNTI CHIAVE ANNUNCIO -->
        {% if result.job_summary %}
        <div class="jd-box">
            <div class="jd-title">ğŸ“‹ Punti chiave dell'annuncio</div>
            <div class="jd-text">{{ result.job_summary }}</div>
        </div>
        {% endif %}

        <!-- 5. FORZA + LACUNE side by side -->
        <div class="grid2">
            <div class="str-section">
                <div class="str-header">
                    <div class="sec-title">ğŸ’ª I tuoi punti di forza</div>
                    <span class="str-count">{{ result.strengths|length }}</span>
                </div>
                {% for s in result.strengths %}
                <div class="str-item">
                    <span class="str-icon">âœ…</span>
                    <span class="str-text">{{ s }}</span>
                </div>
                {% endfor %}
            </div>
            <div class="gap-section">
                <div class="str-header">
                    <div class="sec-title">ğŸŒ± Aree di crescita</div>
                    <span class="str-count" style="background:#475569">{{ result.gaps|length }}</span>
                </div>
                {% for g in result.gaps %}
                    {% if g is mapping %}
                    <div class="gap-item sev-{{ g.severity }}-border">
                        <div class="gap-top">
                            <span class="sev sev-{{ g.severity }}">{% if g.severity == 'bloccante' %}ğŸš«{% elif g.severity == 'importante' %}âš ï¸{% else %}ğŸ’¡{% endif %} {{ g.severity }}</span>
                            <span class="gap-name">{{ g.gap }}</span>
                            {% if g.closable %}<span class="gap-closable">âœ¨ colmabile</span>{% else %}<span class="gap-not">ğŸ”’ difficile</span>{% endif %}
                        </div>
                        {% if g.how %}
                        <div class="gap-how">
                            <span class="gap-how-icon">ğŸ› ï¸</span>
                            <span>{{ g.how }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <span class="tag tag-r">{{ g }}</span>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- 5b. CONSIGLIO PERSONALIZZATO -->
        {% if result.advice %}
        <div class="advice-box">
            <div class="advice-title">ğŸ’¡ Il mio consiglio per te</div>
            <div class="advice-text">{{ result.advice }}</div>
        </div>
        {% endif %}

        <!-- 6. COLLOQUIO (collassabile) -->
        {% if result.interview_scripts %}
        <details style="margin-top:16px">
            <summary>ğŸ¤ Preparazione colloquio ({{ result.interview_scripts|length }} domande)</summary>
            {% for s in result.interview_scripts %}
            <div class="script">
                <div class="script-q">â“ {{ s.question }}</div>
                <div class="script-a">ğŸ’¬ {{ s.suggested_answer }}</div>
            </div>
            {% endfor %}
        </details>
        {% endif %}

        <!-- 7. AZIONI -->
        {% if current %}
        <div class="actions" id="actions-{{ current.id }}">
            {% if current.job_url %}
            <a href="{{ current.job_url }}" target="_blank" class="btn btn-b btn-s">ğŸ”— Apri annuncio</a>
            {% endif %}
            <div class="pill-group" data-analysis-id="{{ current.id }}">
                <button class="pill-btn pill-da_valutare {{ 'active' if (current.status or 'da_valutare') == 'da_valutare' }}" data-status="da_valutare" onclick="setStatus(this)">ğŸ” Da valutare</button>
                <button class="pill-btn pill-candidato {{ 'active' if current.status == 'candidato' }}" data-status="candidato" onclick="setStatus(this)">ğŸ“¨ Candidato</button>
                <button class="pill-btn pill-colloquio {{ 'active' if current.status == 'colloquio' }}" data-status="colloquio" onclick="setStatus(this)">ğŸ—£ï¸ Colloquio</button>
                <button class="pill-btn pill-scartato {{ 'active' if current.status == 'scartato' }}" data-status="scartato" onclick="setStatus(this)">âŒ Scartato</button>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- ========== STORICO ========== -->
    {% if analyses %}
    <div class="hist">
        <h2>ğŸ“š Storico analisi</h2>
        <div class="tabs" id="hist-tabs">
            <div class="tab active" data-tab="valutazione" onclick="switchTab(this)">In valutazione <span class="tab-badge" id="badge-valutazione">0</span></div>
            <div class="tab" data-tab="applicato" onclick="switchTab(this)">Applicato <span class="tab-badge" id="badge-applicato">0</span></div>
            <div class="tab" data-tab="skippato" onclick="switchTab(this)">Skippato <span class="tab-badge" id="badge-skippato">0</span></div>
        </div>
        <div class="card" style="padding:0;overflow:hidden" id="hist-list">
            {% for a in analyses %}
            <a href="/analysis/{{ a.id }}" style="text-decoration:none;color:inherit">
            <div class="hi" data-hist-id="{{ a.id }}" data-hist-status="{{ a.status or 'da_valutare' }}">
                <div class="hi-score score-{{ a.recommendation|lower }}">{{ a.score }}</div>
                <div class="hi-info">
                    <div class="hi-role">{{ a.role or 'Ruolo sconosciuto' }}</div>
                    <div class="hi-co">{{ a.company or 'Azienda sconosciuta' }}{% if a.work_mode %} Â· {{ a.work_mode }}{% endif %}{% if a.salary_info %} Â· {{ a.salary_info }}{% endif %}</div>
                </div>
                <span class="st st-{{ a.status or 'da_valutare' }}">{% if a.status == 'candidato' %}ğŸ“¨{% elif a.status == 'colloquio' %}ğŸ—£ï¸{% elif a.status == 'scartato' %}âŒ{% else %}ğŸ”{% endif %} {{ (a.status or 'da valutare')|replace('_',' ') }}</span>
                <span class="rec rec-{{ a.recommendation }}" style="font-size:.72rem;padding:3px 9px">{{ a.recommendation }}</span>
                <span class="hi-date">${{ '%.4f' % (a.cost_usd or 0) }}<br>{{ a.created_at.strftime('%d/%m %H:%M') if a.created_at else '' }}</span>
            </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="foot">ğŸ¯ Job Search Command Center</div>
</div>

<script>
document.getElementById('af').addEventListener('submit',function(){
    document.getElementById('ab').disabled=true;
    document.getElementById('ld').classList.add('on');
});

function setStatus(btn){
    var group=btn.closest('.pill-group');
    var id=group.dataset.analysisId;
    var status=btn.dataset.status;
    fetch('/status/'+id+'/'+status,{method:'POST',headers:{'Accept':'application/json'}})
    .then(function(r){return r.json();}).then(function(data){
        if(data.ok){
            group.querySelectorAll('.pill-btn').forEach(function(b){b.classList.remove('active');});
            btn.classList.add('active');
            var histItem=document.querySelector('[data-hist-id="'+id+'"]');
            if(histItem) histItem.dataset.histStatus=status;
            updateHistTabs();
        }
    });
}

function switchTab(tabEl){
    document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});
    tabEl.classList.add('active');
    updateHistTabs();
}
function updateHistTabs(){
    var activeTab=document.querySelector('.tab.active');
    if(!activeTab) return;
    var tab=activeTab.dataset.tab;
    var countVal=0,countApp=0,countSkip=0;
    document.querySelectorAll('.hi').forEach(function(hi){
        var st=hi.dataset.histStatus||'da_valutare';
        var isVal=st==='da_valutare';
        var isApp=st==='candidato'||st==='colloquio';
        var isSkip=st==='scartato';
        if(tab==='valutazione') hi.parentElement.style.display=isVal?'':'none';
        else if(tab==='applicato') hi.parentElement.style.display=isApp?'':'none';
        else hi.parentElement.style.display=isSkip?'':'none';
        if(isVal)countVal++;if(isApp)countApp++;if(isSkip)countSkip++;
    });
    document.getElementById('badge-valutazione').textContent=countVal;
    document.getElementById('badge-applicato').textContent=countApp;
    document.getElementById('badge-skippato').textContent=countSkip;
}
document.addEventListener('DOMContentLoaded',function(){if(document.getElementById('hist-tabs'))updateHistTabs();});
var clf=document.getElementById('clf');
if(clf){clf.addEventListener('submit',function(){document.getElementById('cld').classList.add('on');});}

var batchItems=[];
function batchAdd(){
    var jd=document.getElementById('batch-jd').value.trim();
    if(!jd){alert('Inserisci una descrizione del lavoro');return;}
    var url=document.getElementById('batch-url').value.trim();
    var model=document.querySelector('input[name="batch_model"]:checked').value;
    var fd=new FormData();fd.append('job_description',jd);fd.append('job_url',url);fd.append('model',model);
    fetch('/batch/add',{method:'POST',body:fd}).then(function(r){return r.json();}).then(function(data){
        if(data.ok){
            batchItems.push({preview:jd.substring(0,80)+(jd.length>80?'...':''),status:'pending',result_preview:''});
            renderBatchQueue();
            document.getElementById('batch-jd').value='';
            document.getElementById('batch-url').value='';
        }
    });
}
function renderBatchQueue(){
    var q=document.getElementById('batch-queue');
    var acts=document.getElementById('batch-actions');
    while(q.firstChild)q.removeChild(q.firstChild);
    if(batchItems.length===0){acts.style.display='none';return;}
    acts.style.display='flex';
    batchItems.forEach(function(item,i){
        var color=item.status==='done'?'#34d399':item.status==='running'?'#fbbf24':item.status==='error'?'#f87171':'#64748b';
        var row=document.createElement('div');
        row.style.cssText='display:flex;align-items:center;gap:8px;padding:6px 10px;border-bottom:1px solid #1e293b;font-size:.82rem';
        var num=document.createElement('span');
        num.style.cssText='color:'+color+';font-weight:600';
        num.textContent='['+(i+1)+']';
        var prev=document.createElement('span');
        prev.style.cssText='flex:1;color:#cbd5e1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
        prev.textContent=item.preview;
        var st=document.createElement('span');
        st.style.cssText='color:'+color+';font-size:.75rem';
        st.textContent=item.status;
        row.appendChild(num);row.appendChild(prev);row.appendChild(st);
        if(item.result_preview){
            var rp=document.createElement('span');
            rp.style.cssText='color:#94a3b8;font-size:.72rem';
            rp.textContent=item.result_preview;
            row.appendChild(rp);
        }
        q.appendChild(row);
    });
}
function batchRun(){
    fetch('/batch/run',{method:'POST'}).then(function(r){return r.json();}).then(function(data){
        if(data.ok){
            document.getElementById('batch-status-text').textContent='Analisi in corso...';
            pollBatch();
        }
    });
}
function pollBatch(){
    fetch('/batch/status').then(function(r){return r.json();}).then(function(data){
        if(data.items){
            data.items.forEach(function(item,i){
                if(batchItems[i]){
                    batchItems[i].status=item.status;
                    if(item.result_preview)batchItems[i].result_preview=item.result_preview;
                }
            });
            renderBatchQueue();
        }
        if(data.status==='running'){setTimeout(pollBatch,2000);}
        else if(data.status==='done'){
            document.getElementById('batch-status-text').textContent='Completato! Ricarica la pagina per vedere i risultati.';
        }
    });
}
function batchClear(){
    fetch('/batch/clear',{method:'DELETE'}).then(function(r){return r.json();}).then(function(){
        batchItems=[];renderBatchQueue();
        document.getElementById('batch-status-text').textContent='';
    });
}
</script>
</body>
</html>
