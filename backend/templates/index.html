<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ Job Search Command Center</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="c">
    <div class="top">
        <h1>ğŸ¯ Job Search Command Center</h1>
        {% if spending %}
        <div class="spend">
            <span>ğŸ’° Speso: <b>${{ '%.4f' % spending.total_cost_usd }}</b></span>
            <span>ğŸ’³ Saldo: <b class="bal">${{ '%.4f' % spending.balance_usd }}</b></span>
            <div class="bar-bg"><div class="bar-fg" style="width:{{ [(spending.total_cost_usd / 5.0 * 100)|round(1), 100]|min }}%"></div></div>
            <span>ğŸ“Š Analisi: <b>{{ spending.total_analyses }}</b></span>
            <span>ğŸ”¤ Token: <b>{{ '{:,}'.format(spending.total_tokens_input + spending.total_tokens_output) }}</b></span>
        </div>
        {% endif %}
    </div>

    {% if message %}<div class="msg msg-ok">âœ… {{ message }}</div>{% endif %}
    {% if error %}<div class="msg msg-err">âŒ {{ error }}</div>{% endif %}

    <div class="grid">
        <div class="card">
            <h2>ğŸ“„ Il tuo CV</h2>
            {% if cv %}
            <div class="cv-st cv-ok">âœ… CV caricato ({{ cv.name or 'senza nome' }}) &mdash; incolla di nuovo per aggiornare</div>
            {% else %}
            <div class="cv-st cv-no">âš ï¸ Nessun CV &mdash; incollalo qui sotto</div>
            {% endif %}
            <form method="post" action="/cv">
                <input type="text" name="cv_name" placeholder="ğŸ‘¤ Il tuo nome (opzionale)" value="{{ cv.name if cv else '' }}">
                <textarea name="cv_text" placeholder="ğŸ“‹ Incolla qui il tuo CV completo..."></textarea>
                <div class="btns">
                    <button type="submit" class="btn btn-p">ğŸ’¾ Salva CV</button>
                    {% if cv %}<button type="button" class="btn btn-muted btn-s" disabled title="Prossimamente">ğŸ“¥ Scarica CV</button>{% endif %}
                </div>
            </form>
        </div>
        <div class="card">
            <h2>ğŸ” Analizza candidatura</h2>
            <form method="post" action="/analyze" id="af">
                <input type="url" name="job_url" placeholder="ğŸ”— Link annuncio (LinkedIn, Indeed...) - opzionale">
                <textarea name="job_description" placeholder="ğŸ“ Incolla qui la descrizione del lavoro..."></textarea>
                <div class="btns">
                    <button type="submit" class="btn btn-a" id="ab">âš¡ Analizza</button>
                    <div class="toggle">
                        <input type="radio" name="model" value="haiku" id="mh" checked><label for="mh">ğŸ‡ Haiku</label>
                        <input type="radio" name="model" value="sonnet" id="ms"><label for="ms">ğŸ§  Sonnet</label>
                    </div>
                </div>
            </form>
            <div class="loading" id="ld"><div class="spin"></div><span>ğŸ¤– Analisi AI in corso...</span></div>
        </div>
    </div>

    <!-- ========== COVER LETTER ========== -->
    {% if analyses %}
    <div class="card" style="margin-bottom:20px">
        <h2>âœ‰ï¸ Cover Letter</h2>
        <form method="post" action="/cover-letter" id="clf">
            <select name="analysis_id" style="width:100%;background:#0f172a;border:1px solid #475569;border-radius:6px;padding:8px 10px;color:#e2e8f0;font-size:.85rem;margin-bottom:8px">
                {% for a in analyses %}
                <option value="{{ a.id }}">{{ a.role or 'Ruolo' }} @ {{ a.company or 'Azienda' }} ({{ a.score }}/100)</option>
                {% endfor %}
            </select>
            <div class="btns">
                <select name="language" style="background:#0f172a;border:1px solid #475569;border-radius:6px;padding:6px 10px;color:#e2e8f0;font-size:.82rem">
                    <option value="italiano">ğŸ‡®ğŸ‡¹ Italiano</option>
                    <option value="english">ğŸ‡¬ğŸ‡§ English</option>
                    <option value="francais">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                    <option value="deutsch">ğŸ‡©ğŸ‡ª Deutsch</option>
                    <option value="espanol">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                </select>
                <div class="toggle">
                    <input type="radio" name="model" value="haiku" id="clmh" checked><label for="clmh">ğŸ‡ Haiku</label>
                    <input type="radio" name="model" value="sonnet" id="clms"><label for="clms">ğŸ§  Sonnet</label>
                </div>
                <button type="submit" class="btn btn-g">âœ‰ï¸ Genera Cover Letter</button>
            </div>
        </form>
        <div class="loading" id="cld"><div class="spin"></div><span>âœï¸ Generazione in corso...</span></div>
    </div>
    {% endif %}

    {% if cover_letter_result %}
    <div class="card" style="margin-bottom:20px">
        <h2>âœ‰ï¸ Cover Letter generata</h2>
        <div style="margin-bottom:12px">
            <div class="advice-title" style="color:#059669">ğŸ“ Lettera</div>
            <div id="cl-text" style="background:#0f172a;padding:14px;border-radius:8px;border:1px solid #334155;color:#cbd5e1;font-size:.85rem;line-height:1.7;white-space:pre-line;margin-bottom:8px">{{ cover_letter_result.cover_letter }}</div>
            <button class="btn btn-muted btn-s" onclick="navigator.clipboard.writeText(document.getElementById('cl-text').textContent)">ğŸ“‹ Copia lettera</button>
        </div>
        {% if cover_letter_result.subject_lines %}
        <div>
            <div class="advice-title" style="color:#f59e0b">ğŸ“§ Subject line suggerite</div>
            {% for sl in cover_letter_result.subject_lines %}
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                <span style="background:#0f172a;padding:6px 12px;border-radius:6px;border:1px solid #334155;color:#e2e8f0;font-size:.82rem;flex:1" id="sl-{{ loop.index }}">{{ sl }}</span>
                <button class="btn btn-muted btn-s" onclick="navigator.clipboard.writeText(document.getElementById('sl-{{ loop.index }}').textContent)">ğŸ“‹ Copia</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <div style="margin-top:8px;font-size:.72rem;color:#475569">
            ğŸ’° Costo: ${{ '%.5f' % cover_letter_result.cost_usd }} | ğŸ”¤ {{ cover_letter_result.tokens.total }} token
        </div>
    </div>
    {% endif %}

    <!-- ========== BATCH ANALYSIS ========== -->
    <div class="card" style="margin-bottom:20px">
        <h2>ğŸ“¦ Analisi multipla</h2>
        <div id="batch-form">
            <input type="url" id="batch-url" placeholder="ğŸ”— Link annuncio (opzionale)" style="width:100%;background:#0f172a;border:1px solid #475569;border-radius:6px;padding:8px 10px;color:#e2e8f0;font-size:.85rem;margin-bottom:8px">
            <textarea id="batch-jd" placeholder="ğŸ“ Incolla la descrizione del lavoro..." style="width:100%;min-height:80px;background:#0f172a;border:1px solid #475569;border-radius:6px;padding:10px;color:#e2e8f0;font-size:.85rem;resize:vertical;margin-bottom:8px"></textarea>
            <div class="btns">
                <button class="btn btn-a btn-s" onclick="batchAdd()">â• Aggiungi alla coda</button>
                <div class="toggle">
                    <input type="radio" name="batch_model" value="haiku" id="bmh" checked><label for="bmh">ğŸ‡ Haiku</label>
                    <input type="radio" name="batch_model" value="sonnet" id="bms"><label for="bms">ğŸ§  Sonnet</label>
                </div>
            </div>
        </div>
        <div id="batch-queue" style="margin-top:12px"></div>
        <div id="batch-actions" style="display:none;margin-top:10px" class="btns">
            <button class="btn btn-g" onclick="batchRun()">ğŸš€ Analizza tutti</button>
            <button class="btn btn-r btn-s" onclick="batchClear()">ğŸ—‘ï¸ Svuota coda</button>
            <span id="batch-status-text" style="font-size:.82rem;color:#94a3b8"></span>
        </div>
    </div>

    <!-- ========== RISULTATO ========== -->
    {% if result %}
    <div class="card res">

        <!-- 1. HERO: punteggio + ruolo + info rapide -->
        <div class="hero">
            <div class="score score-{{ result.recommendation|lower }}">{{ result.score }}</div>
            <div class="hero-info">
                <div class="hero-top">
                    <span class="rec rec-{{ result.recommendation }}">{% if result.recommendation == 'APPLY' %}ğŸš€{% elif result.recommendation == 'CONSIDER' %}ğŸ¤”{% else %}â›”{% endif %} {{ result.recommendation }}</span>
                    <span class="hero-role">{{ result.role }} @ {{ result.company }}</span>
                </div>
                {% if result.score_label %}<div class="hero-label">{{ result.score_label }}</div>{% endif %}
                <div class="hero-tags">
                    {% if result.location %}<span class="ht ht-loc">ğŸ“ {{ result.location }}</span>{% endif %}
                    {% if result.work_mode %}<span class="ht ht-mode">ğŸ¢ {{ result.work_mode }}</span>{% endif %}
                    {% if result.salary_info %}<span class="ht ht-sal">ğŸ’¶ {{ result.salary_info }}</span>{% endif %}
                    {% if result.potential_score %}<span class="ht ht-pot">ğŸ“ˆ Potenziale: {{ result.potential_score }}/100</span>{% endif %}
                    {% if result.gap_timeline %}<span class="ht ht-time">â±ï¸ {{ result.gap_timeline }}</span>{% endif %}
                    {% if result.confidence %}<span class="ht ht-conf">ğŸ¯ {{ result.confidence }}{% if result.confidence_reason %}: {{ result.confidence_reason }}{% endif %}</span>{% endif %}
                    {% if result.company_reputation and result.company_reputation.glassdoor_estimate and result.company_reputation.glassdoor_estimate != 'non disponibile' %}
                    {% set gr = result.company_reputation.glassdoor_estimate|replace('/5','')|float(0) %}
                    <span class="ht {% if gr >= 4.0 %}ht-sal{% elif gr >= 3.0 %}ht-time{% else %}tag-r{% endif %}" title="{{ result.company_reputation.known_pros|join(', ') }} | {{ result.company_reputation.known_cons|join(', ') }}{% if result.company_reputation.note %} - {{ result.company_reputation.note }}{% endif %}">
                        â­ Glassdoor ~{{ result.company_reputation.glassdoor_estimate }}
                    </span>
                    {% elif result.company_reputation %}
                    <span class="ht ht-conf" title="{{ result.company_reputation.note|default('') }}">â­ Glassdoor: n/d</span>
                    {% endif %}
                </div>
            </div>
            <div class="hero-meta">
                <span class="pill">ğŸ’²{{ '%.5f' % result.cost_usd }}</span><br>
                <span style="font-size:.68rem">{{ result.tokens.total }} tok{% if result.from_cache %} Â· âš¡ cache{% endif %}</span>
            </div>
        </div>

        {% if result.company_reputation and (result.company_reputation.known_pros or result.company_reputation.known_cons) %}
        <details style="margin-bottom:16px" open>
            <summary>ğŸ¢ Reputazione aziendale
                {% set gr_str = result.company_reputation.glassdoor_estimate|default('non disponibile') %}
                {% if gr_str != 'non disponibile' %}
                {% set gr = gr_str|replace('/5','')|float(0) %}
                <span class="rep-rating {% if gr >= 4.0 %}rep-rating-good{% elif gr >= 3.0 %}rep-rating-mid{% else %}rep-rating-low{% endif %}">
                    â­ {{ gr_str }}
                </span>
                {% else %}
                <span class="rep-rating rep-rating-na">â­ n/d</span>
                {% endif %}
            </summary>
            <div class="rep-grid">
                {% if result.company_reputation.known_pros %}
                <div class="rep-col rep-pros">
                    <div class="rep-label rep-label-pro">ğŸ‘ Punti di forza</div>
                    {% for p in result.company_reputation.known_pros %}
                    <div class="rep-item">âœ… {{ p }}</div>
                    {% endfor %}
                </div>
                {% endif %}
                {% if result.company_reputation.known_cons %}
                <div class="rep-col rep-cons">
                    <div class="rep-label rep-label-con">ğŸ‘ Criticita'</div>
                    {% for c in result.company_reputation.known_cons %}
                    <div class="rep-item">âš ï¸ {{ c }}</div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% if result.company_reputation.note %}
            <div class="rep-note">âš ï¸ {{ result.company_reputation.note }}</div>
            {% endif %}
        </details>
        {% endif %}

        <!-- 2. VERDETTO AI -->
        {% if result.summary %}
        <div class="verdict">ğŸ§  {{ result.summary }}</div>
        {% endif %}

        <!-- 4. PUNTI CHIAVE ANNUNCIO -->
        {% if result.job_summary %}
        <div class="jd-box">
            <div class="jd-title">ğŸ“‹ Punti chiave dell'annuncio</div>
            <div class="jd-text">{{ result.job_summary }}</div>
        </div>
        {% endif %}

        <!-- 5. FORZA + LACUNE side by side -->
        <div class="grid2">
            <div class="str-section">
                <div class="str-header">
                    <div class="sec-title">ğŸ’ª I tuoi punti di forza</div>
                    <span class="str-count">{{ result.strengths|length }}</span>
                </div>
                {% for s in result.strengths %}
                <div class="str-item">
                    <span class="str-icon">âœ…</span>
                    <span class="str-text">{{ s }}</span>
                </div>
                {% endfor %}
            </div>
            <div class="gap-section">
                <div class="str-header">
                    <div class="sec-title">ğŸŒ± Aree di crescita</div>
                    <span class="str-count" style="background:#475569">{{ result.gaps|length }}</span>
                </div>
                {% for g in result.gaps %}
                    {% if g is mapping %}
                    <div class="gap-item sev-{{ g.severity }}-border">
                        <div class="gap-top">
                            <span class="sev sev-{{ g.severity }}">{% if g.severity == 'bloccante' %}ğŸš«{% elif g.severity == 'importante' %}âš ï¸{% else %}ğŸ’¡{% endif %} {{ g.severity }}</span>
                            <span class="gap-name">{{ g.gap }}</span>
                            {% if g.closable %}<span class="gap-closable">âœ¨ colmabile</span>{% else %}<span class="gap-not">ğŸ”’ difficile</span>{% endif %}
                        </div>
                        {% if g.how %}
                        <div class="gap-how">
                            <span class="gap-how-icon">ğŸ› ï¸</span>
                            <span>{{ g.how }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <span class="tag tag-r">{{ g }}</span>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- 5b. CONSIGLIO PERSONALIZZATO -->
        {% if result.advice %}
        <div class="advice-box">
            <div class="advice-title">ğŸ’¡ Il mio consiglio per te</div>
            <div class="advice-text">{{ result.advice }}</div>
        </div>
        {% endif %}

        <!-- 6. COLLOQUIO (collassabile) -->
        {% if result.interview_scripts %}
        <details style="margin-top:16px">
            <summary>ğŸ¤ Preparazione colloquio ({{ result.interview_scripts|length }} domande)</summary>
            {% for s in result.interview_scripts %}
            <div class="script">
                <div class="script-q">â“ {{ s.question }}</div>
                <div class="script-a">ğŸ’¬ {{ s.suggested_answer }}</div>
            </div>
            {% endfor %}
        </details>
        {% endif %}

        <!-- 7. AZIONI -->
        {% if current %}
        <div class="actions" id="actions-{{ current.id }}">
            {% if current.job_url %}
            <a href="{{ current.job_url }}" target="_blank" class="btn btn-b btn-s">ğŸ”— Apri annuncio</a>
            {% endif %}
            <div class="pill-group" data-analysis-id="{{ current.id }}">
                <button class="pill-btn pill-da_valutare {{ 'active' if (current.status or 'da_valutare') == 'da_valutare' }}" data-status="da_valutare" onclick="setStatus(this)">ğŸ” Da valutare</button>
                <button class="pill-btn pill-candidato {{ 'active' if current.status == 'candidato' }}" data-status="candidato" onclick="setStatus(this)">ğŸ“¨ Candidato</button>
                <button class="pill-btn pill-colloquio {{ 'active' if current.status == 'colloquio' }}" data-status="colloquio" onclick="setStatus(this)">ğŸ—£ï¸ Colloquio</button>
                <button class="pill-btn pill-scartato {{ 'active' if current.status == 'scartato' }}" data-status="scartato" onclick="setStatus(this)">âŒ Scartato</button>
            </div>
            <button class="btn btn-r btn-s" onclick="deleteAnalysis('{{ current.id }}')">ğŸ—‘ï¸ Elimina</button>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- ========== STORICO ========== -->
    {% if analyses %}
    <div class="hist">
        <h2>ğŸ“š Storico analisi</h2>
        <div class="tabs" id="hist-tabs">
            <div class="tab active" data-tab="valutazione" onclick="switchTab(this)">In valutazione <span class="tab-badge" id="badge-valutazione">0</span></div>
            <div class="tab" data-tab="applicato" onclick="switchTab(this)">Applicato <span class="tab-badge" id="badge-applicato">0</span></div>
            <div class="tab" data-tab="skippato" onclick="switchTab(this)">Skippato <span class="tab-badge" id="badge-skippato">0</span></div>
        </div>
        <div class="card" style="padding:0;overflow:hidden" id="hist-list">
            {% for a in analyses %}
            <div class="hi" data-hist-id="{{ a.id }}" data-hist-status="{{ a.status or 'da_valutare' }}">
                <a href="/analysis/{{ a.id }}" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:10px;flex:1;min-width:0">
                    <div class="hi-score score-{{ a.recommendation|lower }}">{{ a.score }}</div>
                    <div class="hi-info">
                        <div class="hi-role">{{ a.role or 'Ruolo sconosciuto' }}</div>
                        <div class="hi-co">{{ a.company or 'Azienda sconosciuta' }}{% if a.work_mode %} Â· {{ a.work_mode }}{% endif %}{% if a.salary_info %} Â· {{ a.salary_info }}{% endif %}</div>
                    </div>
                    <span class="st st-{{ a.status or 'da_valutare' }}">{% if a.status == 'candidato' %}ğŸ“¨{% elif a.status == 'colloquio' %}ğŸ—£ï¸{% elif a.status == 'scartato' %}âŒ{% else %}ğŸ”{% endif %} {{ (a.status or 'da valutare')|replace('_',' ') }}</span>
                    <span class="rec rec-{{ a.recommendation }}" style="font-size:.72rem;padding:3px 9px">{{ a.recommendation }}</span>
                    <span class="hi-date">${{ '%.4f' % (a.cost_usd or 0) }}<br>{{ a.created_at.strftime('%d/%m %H:%M') if a.created_at else '' }}</span>
                </a>
                <button class="btn btn-r btn-s" onclick="deleteAnalysis('{{ a.id }}')" title="Elimina" style="flex-shrink:0">ğŸ—‘ï¸</button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="foot">ğŸ¯ Job Search Command Center</div>
</div>

<script src="/static/js/app.js"></script>
</body>
</html>
